<button class="chat-fab" id="chatFab" onclick="toggleChatPanel()" title="Ask about gardening or cooking">ðŸ’¬</button>

<div class="chat-panel" id="chatPanel">
    <div class="chat-panel-header">
        <span class="chat-panel-title">Gardening & Cooking Assistant</span>
        <button class="chat-close-btn" onclick="toggleChatPanel()">Ã—</button>
    </div>
    <div class="chat-messages" id="chatMessages">
        <div class="chat-welcome" id="chatWelcome">
            Ask me about growing herbs, vegetables, recipes, or cooking tips!
        </div>
    </div>
    <div class="chat-input-wrap">
        <input type="text" id="chatInput" class="chat-input" placeholder="Ask a question..." />
        <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">Send</button>
    </div>
</div>

<style>
.chat-fab {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, #7db87d, #6aaa6a);
    border: 1px solid #5a9a5a;
    color: white;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    z-index: 1000;
    transition: transform 0.2s, box-shadow 0.2s;
}
.chat-fab:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(125, 184, 125, 0.3);
}

.chat-panel {
    display: none;
    position: fixed;
    bottom: 0;
    right: 0;
    left: 0;
    max-width: 480px;
    margin: 0 auto;
    height: 420px;
    max-height: 70vh;
    background-color: #161616;
    border: 1px solid #1e1e1e;
    border-radius: 20px 20px 0 0;
    box-shadow: 0 -4px 24px rgba(0,0,0,0.5);
    z-index: 1001;
    flex-direction: column;
    overflow: hidden;
}

.chat-panel.open {
    display: flex;
}

.chat-panel-header {
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #1e1e1e;
    background-color: #1a1a1a;
}

.chat-panel-title {
    font-family: 'Playfair Display', serif;
    font-size: 16px;
    color: #f0ebe3;
}

.chat-close-btn {
    background: none;
    border: none;
    color: #888;
    font-size: 24px;
    cursor: pointer;
    line-height: 1;
    padding: 0;
}

.chat-close-btn:hover {
    color: #ff6b35;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.chat-welcome {
    font-size: 14px;
    color: #666;
    text-align: center;
    padding: 24px 16px;
}

.chat-msg {
    max-width: 85%;
    padding: 12px 16px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.5;
    word-wrap: break-word;
}

.chat-msg.user {
    align-self: flex-end;
    background: linear-gradient(135deg, #ff6b35, #ff9500);
    color: white;
    border-bottom-right-radius: 4px;
}

.chat-msg.bot {
    align-self: flex-start;
    background-color: #1e1e1e;
    color: #f0ebe3;
    border: 1px solid #2a2a2a;
    border-bottom-left-radius: 4px;
}

.chat-msg.error {
    align-self: flex-start;
    background-color: #2a1818;
    color: #ff8c8c;
    border: 1px solid #3a2828;
}

.chat-input-wrap {
    padding: 12px 16px 20px;
    display: flex;
    gap: 10px;
    border-top: 1px solid #1e1e1e;
    background-color: #161616;
}

.chat-input {
    flex: 1;
    padding: 12px 16px;
    border-radius: 20px;
    border: 1px solid #2a2a2a;
    background-color: #1a1a1a;
    color: #f0ebe3;
    font-size: 15px;
    font-family: 'DM Sans', sans-serif;
    outline: none;
}

.chat-input:focus {
    border-color: #7db87d;
}

.chat-input::placeholder {
    color: #444;
}

.chat-send-btn {
    padding: 12px 20px;
    border-radius: 20px;
    border: none;
    background: linear-gradient(135deg, #7db87d, #6aaa6a);
    color: white;
    font-size: 14px;
    font-weight: 500;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    transition: opacity 0.2s;
}

.chat-send-btn:hover {
    opacity: 0.9;
}

.chat-send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
</style>

<script>
function toggleChatPanel() {
    const panel = document.getElementById('chatPanel');
    const fab = document.getElementById('chatFab');
    if (panel.classList.contains('open')) {
        panel.classList.remove('open');
        fab.style.display = 'flex';
    } else {
        panel.classList.add('open');
        fab.style.display = 'none';
        document.getElementById('chatInput').focus();
    }
}

function appendMessage(content, role) {
    const welcome = document.getElementById('chatWelcome');
    if (welcome) welcome.style.display = 'none';

    const container = document.getElementById('chatMessages');
    const div = document.createElement('div');
    div.className = 'chat-msg ' + role;
    div.textContent = content;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

async function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const btn = document.getElementById('chatSendBtn');
    const msg = input.value.trim();
    if (!msg) return;

    input.value = '';
    appendMessage(msg, 'user');
    btn.disabled = true;

    try {
        const resp = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: msg }),
        });
        const data = await resp.json();

        if (resp.ok && data.reply) {
            appendMessage(data.reply, 'bot');
        } else {
            const errMsg = data.error || 'Something went wrong. Try again.';
            appendMessage(errMsg, 'error');
        }
    } catch (e) {
        appendMessage('Failed to connect. Please try again.', 'error');
    } finally {
        btn.disabled = false;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('chatInput');
    if (input) {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendChatMessage();
        });
    }
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('chat') === '1') {
        toggleChatPanel();
        window.history.replaceState({}, '', window.location.pathname);
    }
});
</script>
